---
title: "exp7_analysis"
author: "gal"
date: '2023-08-28'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)
library(ggforce)
library(pracma)
library(lmerTest)
library(readr)
library(stringr)
library(bbmle)
```

Load data
```{r}
# data
data_df = read.csv("processed_data/after_qc/exp7_data.csv") %>% mutate(experiment = 7)

# experimenter manual exclusions
exclusions_df = read.csv('data/exp7/exclusions/exclusions.csv') %>% mutate(experiment = 7)
print(exclusions_df)
```


Combine datasets & exclusions files
```{r}
```


Wrangle data df
```{r}

# separate trial type column
data_df %<>% separate(Trials.trialType, sep = '-', into = c('fam_or_test', 'fam_duration', 'test_type','animal')) 

# create block number variable
data_df <- data_df %>% arrange(experiment, SubjectInfo.subjID, Trials.ordinal) %>% group_by(experiment, SubjectInfo.subjID) %>%   mutate(value_change = (fam_duration != lag(fam_duration, default = first(fam_duration))) | 
           (test_type != lag(test_type, default = first(test_type)))) %>% # Create a logical column indicating whether the values changed compared to the previous row
  mutate(block_num = 1 + cumsum(value_change)) %>% # Create a new column 'group_number' by cumulative sum of value_change
  select(-value_change) # Remove the intermediate value_change column

# make fam duration numeric
# data_df %<>% mutate(fam_duration = as.numeric(fam_duration))
data_df %<>% mutate(animal = as.numeric(animal))
data_df %<>% mutate(test_type = case_when(test_type == "background" ~ "background",
                                          test_type == "identity" ~ "identity",
                                          test_type == "pose" ~ "pose",
                                          test_type == "animacy" ~ "animacy",
                                          test_type == "number" ~ "number"))
# rename a bunch of columns
data_df %<>% rename(subject_num = SubjectInfo.subjID, LT = Looks.duration_onLooks, age = SubjectInfo.testAge, sex = SubjectInfo.gender)

# add fam durations to make plots complete
data_df %<>% complete(fam_duration)
```


# Get stimuli & sharing level

```{r}

# jspsych files

jspsych_files_exp7 <- list.files("data/exp7", full.names = T) 
jspsych_list_exp7 <- lapply(jspsych_files_exp7[2:length(jspsych_files_exp7)], read.csv)
jspsych_list_exp7 <- lapply(jspsych_list_exp7, function(x) {x['success'] = NULL; x})
subject_numbers_exp7 = parse_number(str_replace(jspsych_files_exp7[2:length(jspsych_files_exp7)], "data/exp7/",""))
subject_mapping_exp7 <- data.frame(old_subject = as.character(seq(1, length(subject_numbers_exp7))), new_subject = subject_numbers_exp7)
jspsych_df_exp7 <- map_dfr(jspsych_list_exp7, ~ .x, .id = 'subjectid') %>% mutate(experiment = 7) %>% 
  left_join(subject_mapping_exp7, by = c("subjectid" = "old_subject")) %>% select(-subjectid) %>% rename(subjectid = new_subject)
extras <- c("stimuli/images/unity_stims/|fam8|fam9|/") 
types <- c("pose|animacy|number|identity|background")

trial_df = rbind(jspsych_df_exp7) %>% filter(stimulus_type == 'trial') %>% 
  mutate(stimulus_displayed = str_replace_all(stimulus_displayed, extras,"")) %>% mutate(stimulus_displayed = str_replace(stimulus_displayed, types,"")) %>%select(-c(subject_num)) %>% rename(block_num = block_number, subject_num = subjectid) %>%
  mutate(subject_num = as.numeric(subject_num)) %>% separate(stimulus_displayed, sep = '_', into = c("animate", 'animal_pair', 'fam','block_type', 'junk')) %>% mutate(
    animal_pair = as.numeric(animal_pair)) %>%
  select(subject_num, block_num, experiment, animal_pair,fam)

consent_df_exp7 <- jspsych_df_exp7 %>% filter(nchar(response) > 5) %>% select(subjectid, response) %>% 
  mutate(consent_level = case_when(str_detect(response, 'Private') ~ 'private', 
                                   str_detect(response, 'Scientific') ~ 'scientific',
                                   str_detect(response, 'General Public') ~ 'public'))

```

Exclusions
```{r}

# preallocate exclude from output
data_df %<>% mutate(exclude = as.logical(Trials.excludeTrial))


# drop na from exclusions
for (x in 1:nrow(exclusions_df)){
  print(x)
  exclusion_info = exclusions_df[x,]
  print(exclusion_info$onwards)
  
  # need to add 0 for for subject numbers < 10
  if (x < 10) {
    extra_str = "0"
  }
  else {extra_str = ""}
  
  if (exclusion_info$onwards){   # if onwards = T, then remove all trials starting from that trial onwards
      data_df %<>% mutate(
      exclude = case_when(
                  subject_num == paste0("PKBB_", extra_str, exclusion_info$subject_number) & 
                  block_num >= exclusion_info$trial_number ~ T,
            TRUE ~ exclude))
    
  }
  else {  # if onwards = F, then only mark trial of that number
    data_df %<>% mutate(
      exclude = case_when(
                  subject_num == paste0("PKBB_", extra_str, exclusion_info$subject_number) & 
                  block_num == exclusion_info$trial_number ~ T,
            TRUE ~ exclude))
    
  
  }
}
print(data_df["exclude"])
# merge with stim info

# data_df <- data_df %>% mutate(subject_num = parse_number(subject_num)) %>% left_join(trial_df, by = c('subject_num','block_num')) %>% mutate(animal = 
#   case_when(pair_counterbalancing == 1 ~ 1 + (animal_pair-1) * 2,
#             pair_counterbalancing == 2 ~ 2 + (animal_pair-1) * 2)) %>%
#   mutate(animal = case_when(test_type == 'nov' & fam_or_test == 'test' & mod(animal,2) == 1 ~ animal + 1,
#                             test_type == 'nov' & fam_or_test == 'test' & mod(animal,2) == 0 ~ animal - 1,
#                              TRUE ~ animal))
```


New plots
```{r}

# prepare plot df
plot_df = data_df %>% filter(fam_or_test == 'test', !exclude) %>% mutate(test_type = factor(test_type, levels = c('background', 'pose','identity','number','animacy')))

# main effect by violation type
ggplot(plot_df, aes(x=test_type, y=LT, color = test_type)) + geom_jitter(alpha=0.2, position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", linewidth = 2, position = position_dodge(width = .1))  + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", size = 1, position = position_dodge(width = .1)) + xlab('Trial type') + ylab('LT in s') + labs(color = 'violation type') + theme_classic(base_size = 10) + 
  theme(strip.text.x = element_text(size = 20, colour = "black")) +ggtitle('exp7') + coord_cartesian(ylim = c(0,30)) 

# within subject dishabituation

# Separate the background condition
backgrounds <- plot_df %>% 
  filter(test_type == "background")

# Compute the within-subject differences
within_subject_diff <- plot_df %>%
  filter(test_type != "background") %>%
  left_join(backgrounds, by = "subject_num", suffix = c("_exp", "_bg")) %>%
  mutate(diff = LT_exp - LT_bg)

ggplot(within_subject_diff, aes(x = test_type_exp, y = diff, color = test_type_exp)) + geom_jitter(alpha=0.3, position = position_dodge(width = .2)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", linewidth = 2, position = position_dodge(width = .1)) + stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", size = 1, position = position_dodge(width = .1)) + 
  ylab(' deviant - background (in sec)') + xlab('Test type') + theme_grey(base_size = 15) 
```




Pre-registered models
```{r}

# only test, no excluded trials, add violation or not
model_df = data_df %>% filter(fam_or_test == 'test', !exclude) %>% mutate(is_violation = case_when(test_type == 'background' ~ FALSE, TRUE ~ TRUE))

# and set background as reference
model_df$test_type = relevel(as.factor(model_df$test_type), ref = "background")


# model 1A and model 1B
model_1A <- lmer(log(LT) ~ log(block_num) + (1|subject_num), data = model_df) 
model_1B <- lmer(log(LT) ~ log(block_num) + is_violation + (1|subject_num), data = model_df) 
model_1C <- lmer(log(LT) ~ log(block_num)* test_type - test_type  + (1|subject_num), data = model_df)

anova(model_1B, model_1C)

AICtab(model_1A, model_1B)

```

Power analysis + adjusted p-value size
```{r}

# Start with 50 subjects, for null hypothesis vs. 


# p-value adjustment based on: https://onlinelibrary.wiley.com/doi/pdf/10.1002/ejsp.2023

https://www.sciencedirect.com/science/article/pii/S0163638318300894?via%3Dihub Box 1

```




