---
title: "baby_analysis"
author: "Gal"
date: "6/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
library(dplyr)
library(janitor)
```

## load files

```{r }

# jspsych files
setwd(here())
looking_list <- read_excel_allsheets(here("data", "output.xlsx"))


# jspsych files
jspsych_files <- list.files("data/jspsych")
setwd(here("data", "jspsych"))
jspsych_list <- lapply(jspsych_files, read.csv)
```

## reshape dfs

```{r}
looking_df <- map_dfr(looking_list, ~ .x, .id = 'subject') %>% clean_names()
jspsych_df <- map_dfr(jspsych_list, ~ .x, .id = 'subjectid') 

# get age and gender
age_and_gender <- jspsych_df %>% select(responses) %>%
  filter(responses != "") %>%
  separate(responses, into = c('age', 'gender'), sep=',') %>% 
    separate(age, into = c('del', 'age'), sep=':') %>% 
    separate(gender, into = c('del2', 'gender'), sep=':') %>%
  extract(age, "age") %>% extract(gender, "gender") %>%
  select(age, gender) %>% mutate(subject_id = 1:n())



# get trials
trial_df <- jspsych_df %>%
  filter(stimulus_type == 'trial') %>% 
  select(subject, rt, stimulus_displayed, block_number, block_type) %>%
  group_by(subject) %>% mutate(subject_id = cur_group_id(),
                               stimulus = str_match(stimulus_displayed, "simple_\\s*(.*?)\\s*_A.gif")[,2]) %>%
  group_by(subject_id, block_number) %>% 
  mutate(trial_num = 1:n(),
         stimulus = as.numeric(stimulus),
        valid = case_when(    
        #mark blocks with uneven trial num or less than 4 (ended prematurely)  
        n() %% 2 != 0 ~ FALSE, 
        n() < 4 ~ FALSE,
        TRUE ~ TRUE),
        fam_or_test = case_when( # last trial is test, rest if familiarization
        trial_num < n() ~ 'fam',
        trial_num == n() ~ 'test'
        ),
        fam_duration = max(trial_num) - 1, # how many fam trials in this block
        block_number = block_number + 1) %>%
  group_by(subject_id, block_number, fam_or_test) %>%
  # remove fam trials except last, because this is the format of the looking data (one row for all fam trials)
  filter(!(fam_or_test == 'fam' & trial_num < n())) %>%
  ungroup() %>%
  left_join(age_and_gender, by= 'subject_id')  # add age & gender info
  
  
  
  # check for subjects with missing blocks (when experiment was ended prematurely)
incomplete_subjects <- trial_df %>% 
                      group_by(subject_id) %>% 
                      summarise(count = n_distinct(block_number)) %>% 
                      filter(count<6) %>% 
                      pull(subject_id)

# complete missing blocks (for experiments that ended prematurely)
trial_df <- trial_df %>% complete(subject_id, nesting(block_number, fam_or_test)) %>%
   # make these trials invalid
  # add temp_id
  mutate(valid = case_when(
         is.na(valid) ~ FALSE,
         TRUE ~ valid),
        temp_id = paste0(subject_id, block_number, fam_or_test)) 
  

View(trial_df %>% filter(subject_id == incomplete_subjects))



# add temp id to looking df
looking_df <- looking_df %>% filter(trial_type != 'a') %>% 
  mutate(
    trial_type = case_when(
                  trial_type == 'f' ~ 'fam',
                  trial_type == 't' ~ 'test'),
   subject_num = as.numeric(subject),
  ) %>%
  group_by(subject, trial_type) %>%
  mutate(block_number = row_number(),
         temp_id = paste0(subject_num, block_number, trial_type)) %>%
  rename(looking_time = looks_on_s) %>%
  select(-c("block_number", "subject_num"))


# join trials and looking times
complete_df <- left_join(looking_df, trial_df, by = 'temp_id')  %>%
  select(-c("temp_id", "x1", "trial_number", "subject.x"))

# check that correct columns were added
# 

```

# Exclusions

```{r}

# remove outlier looking times

# remove based on looking at familiarization 


```

# Visualize
```{r pressure, echo=FALSE}

#visualize test looking times
test_df <- complete_df %>% filter(fam_or_test == 'test') 


# calculate means
mean_df <-test_df %>% group_by(block_number) %>% summarize(mean_looking = mean(looking_time))

ggplot(test_df %>% filter(fam_or_test == 'test'), aes(x=block_number, y = looking_time)) + 
  geom_point() + geom_line(aes(group = subject_id)) + geom_point(data=mean_df, aes(x = block_number, y=mean_looking), fill = 'red', shape = 24, size =3)



```

## helper functions
```{r}
read_excel_allsheets <- function(filename, tibble = TRUE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheetsa
    x
}


```