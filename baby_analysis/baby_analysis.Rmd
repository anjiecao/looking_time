---
title: "baby_analysis"
author: "Gal"
date: "6/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(readxl)
library(dplyr)
```

## load files

```{r }

# jspsych files
setwd(here())
looking_list <- read_excel_allsheets(here("data", "output.xlsx"))


# jspsych files
jspsych_files <- list.files("data/jspsych")
setwd(here("data", "jspsych"))
jspsych_list <- lapply(jspsych_files, read.csv)
```

## reshape dfs

```{r}
looking_df <- map_dfr(looking_list, ~ .x, .id = 'subject')
jspsych_df <- map_dfr(jspsych_list, ~ .x, .id = 'subjectid') 

# get age and gender
age_and_gender <- jspsych_df %>% select(responses) %>%
  filter(responses != "") %>%
  separate(responses, into = c('age', 'gender'), sep=',') %>% 
    separate(age, into = c('del', 'age'), sep=':') %>% 
    separate(gender, into = c('del2', 'gender'), sep=':') %>%
  extract(age, "age") %>% extract(gender, "gender") %>%
  select(age, gender) %>% mutate(subject_id = 1:n())



# get trials
trial_df <- jspsych_df %>%
  filter(stimulus_type == 'trial') %>% 
  select(subject, rt, stimulus_displayed, block_number, block_type) %>%
  group_by(subject) %>% mutate(subject_id = cur_group_id(),
                               stimulus = str_match(stimulus_displayed, "simple_\\s*(.*?)\\s*_A.gif")[,2]) %>%
  group_by(subject_id, block_number) %>% 
  mutate(trial_num = 1:n(),
        valid = case_when(    
        #mark blocks with uneven trial num or less than 4 (ended prematurely)  
        n() %% 2 != 0 ~ FALSE, 
        n() < 4 ~ FALSE,
        TRUE ~ TRUE),
        fam_or_test = case_when( # last trial is test, rest if familiarization
        trial_num < n() ~ 'fam',
        trial_num == n() ~ 'test'
        ),
        fam_duration = max(trial_num) - 1 # how many fam trials in this block
        ) %>%
  group_by(subject_id, block_number, fam_or_test) %>%
  # remove fam trials except last, because this is the format of the looking data (one row for all fam trials)
  filter(!(fam_or_test == 'fam' & trial_num < n())) %>%
  ungroup() %>%
  left_join(age_and_gender, by= 'subject_id')  # add age & gender info
  
  
  
  # check for subjects with missing blocks (when experiment was ended prematurely)
incomplete_subjects <- trial_df %>% 
                      group_by(subject_id) %>% 
                      summarise(count = n_distinct(block_number)) %>% 
                      filter(count<6) %>% 
                      pull(subject_id)

# complete missing blocks (for experiments that ended prematurely)
trial_df <- trial_df %>% complete(subject_id, nesting(block_number, fam_or_test)) %>%
  # fill in all the relevant info: age, gender, subject id, valid=FALSE (leave rest as NA)
  #

# check that correct columns were added
View(trial_df %>% filter(subject_id == incomplete_subjects))



# add rows for missing trials


  
  # combine jspsych info with looking info
  

  
  

  
  
  
  

                                       # ) %>%



looking_df %>% mutate(),
                      trial_type = ,
                      test_type =  case_when(
                        rt == 
                      ))


```

```{r pressure, echo=FALSE}
jspsych_df 


```

## helper functions
```{r}
read_excel_allsheets <- function(filename, tibble = TRUE) {
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheetsa
    x
}


```