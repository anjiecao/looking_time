---
title: "01_preprocessing.rmd"
author: "anjie"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: no
---

```{r message=FALSE, warning=FALSE}
library(ggiraphExtra)
library(tidyverse)
library(here)
library(stringr) # for parsing r string 
library(jsonlite) # for parsing r string 

d_path <- here("data/merged_data/merged_data.csv")
df.raw <- read_csv(d_path)
```

# RT data 
```{r}
 
TEST_TRIAL <- c("pref_reveal", "trial")
# do we want to go w/ the data wrangling route or the jspsych route? 
df.deviant <- df.raw %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, rt,
         block_number, block_type, stimulus_displayed) %>% 
  group_by(subject, block_number, stimulus_displayed) %>%
  count() %>% 
  group_by(subject, block_number) %>% 
  mutate(
   deviant = !(n == max(n)) # deviant has less occurence
  ) %>% 
  mutate(
    identifier = paste0(subject, stimulus_displayed)
  ) %>% 
  ungroup() %>% 
  select(identifier, deviant) 

df.processed <- df.raw %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, rt,
         block_number, block_type, stimulus_displayed) %>% 
  group_by(subject, block_number) %>% 
  mutate(
    trial_number = row_number(), 
    identifier = paste0(subject, stimulus_displayed)) %>% 
  left_join(df.deviant, by = "identifier") %>% 
  mutate(
    trial_type = if_else(deviant, "deviant", "background"),
    trial_complexity = case_when(
      grepl("simple", stimulus_displayed) ~ "simple", 
      grepl("complex", stimulus_displayed) ~ "complex"
    )
  ) %>%   
  mutate(block_similarity = case_when(
      grepl("_similar", block_type) ~ "similar", 
      grepl("_dissimilar", block_type) ~ "dissimilar"
    )
  ) %>%   
  mutate(plotting_var = case_when(
    trial_type == 'background' ~ trial_type,
    trial_type == 'deviant' ~ block_similarity
    )
  ) %>%   
  select(subject, block_number, block_type, trial_number, plotting_var, trial_type, trial_complexity, rt) %>% 
  transform(rt = as.numeric(rt))

# df.main
```

# Basic plotting of RT data
```{r}

summarized <- df.processed %>%
group_by(trial_number, plotting_var, trial_complexity) %>% 
summarise(meanRT=mean(rt), maxRT=max(rt), minRT=min(rt), medianRT=median(rt), Std=sd(rt), SE = std.error(rt), n = n())

ggplot(summarized, aes(x=trial_number, y=medianRT, colour=plotting_var)) + geom_line() + geom_errorbar(aes(ymin=medianRT-SE, ymax=medianRT+SE),
                width=0.8, size = 0.8, position = position_dodge(width = 0.2), show.legend = FALSE, alpha = 0.8) +
  geom_point(position = position_dodge(width = 0.2), size=2.5) + geom_line(size=1.2, position = position_dodge(width = 0.2)) + ylab("RT [msec]") +
  theme_gray()  + theme(
    panel.grid.minor = element_blank(), 
    plot.title = element_text(hjust=0.5, size=22, face="bold"),
    axis.title.x = element_text(size=18, face='bold'),
    axis.title.y = element_text(size=18, face='bold'),
    axis.text = element_text(size=15),
    legend.title = element_blank(),
    legend.text = element_text(size=14, face='bold'),
    strip.text = element_text(size=17, face='bold'),
    legend.key.size = unit(2.5, 'lines')) + 
  scale_x_continuous(name="Trial Number", breaks =c(2,4,6,8)) +
  facet_grid(~trial_complexity)

```

# Norming Data 
## similarity 
```{r}
# complexity doesn't have trial type
df.similarity <- df.raw %>% 
  filter(trial_type == "survey-likert") %>% 
  mutate(
    question_type = case_when(
      stimulus_type == "similarity_question" ~ "similarity", 
      TRUE ~ "complexity" 
    )
  ) %>% 
  filter(question_type =="similarity") %>% 
  select(subject, question_type, rt, responses, stimulus_left, stimulus_right) %>% 
  # a dumb way to extrat the rating
  separate(responses, into = c("question", "raw_answer"), sep = ":") %>% 
  mutate(
    rating = as.numeric(str_extract(raw_answer, "[[:digit:]]+"))) %>% 
  select(subject, question_type, stimulus_left, stimulus_right, rating)

df.similarity
```
## complexity 
```{r}
df.complexity <- df.raw %>% 
  filter(trial_type == "survey-likert") %>% 
  mutate(
    question_type = case_when(
      stimulus_type == "similarity_question" ~ "similarity", 
      TRUE ~ "complexity" 
    )
  ) %>% 
  filter(question_type =="complexity") %>% 
  select(subject, question_type, rt, responses, stimulus) %>% 
  # a dumb way to extrat the rating
  separate(responses, into = c("question", "raw_answer"), sep = ":") %>% 
  mutate(
    rating = as.numeric(str_extract(raw_answer, "[[:digit:]]+"))) %>% 
  select(subject, question_type, stimulus, rating)


df.complexity
```

# Demographic information 

```{r}
df.demog <- df.raw  %>% 
  filter(grepl("demog", trial_type)) %>% 
  select(subject, trial_type, responses) %>% 
  toJSON() %>% 
  fromJSON() %>% 
    mutate(
      demog_question = map(responses, ~ fromJSON(.) %>% as.data.frame())) %>% 
    unnest(demog_question)  %>% 
  group_by(subject) %>%
  mutate_at(vars(-group_cols()), function(x) {x[!is.na(x)][1]}) %>%
  distinct() %>% 
  select(-responses, -trial_type)

df.demog
```

# TODO 
## put them together? <- not sure if necessary 
## exclusion criteria 
