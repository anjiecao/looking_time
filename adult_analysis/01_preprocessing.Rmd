---
title: "01_preprocessing.rmd"
author: "anjie & gal"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: no
---

```{r message=FALSE, warning=FALSE}
library(here)
library(tidyverse)
library(stringr) # for parsing r string 
library(jsonlite) # for parsing r string 

d_path <- here("data/merged_data/merged_data.csv")
# d_path <- here("data/raw_data/testSS1612925903745.csv")
df.raw <- read_csv(d_path)
```

# RT data 
```{r}
TEST_TRIAL <- c("pref_reveal", "trial")
# do we want to go w/ the data wrangling route or the jspsych route? 
df.deviant <- df.raw %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, rt,
         block_number, block_type, stimulus_displayed) %>% 
  group_by(subject, block_number, stimulus_displayed) %>%
  count() %>% 
  group_by(subject, block_number) %>% 
  mutate(
   deviant = !(n == max(n)) # deviant has less occurence
  ) %>% 
  mutate(
    identifier = paste0(subject, stimulus_displayed)
  ) %>% 
  ungroup() %>% 
  select(identifier, deviant) 

df.processed <- df.raw %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, rt,
         block_number, block_type, stimulus_displayed) %>% 
  group_by(subject, block_number) %>% 
  mutate(
    trial_number = row_number(), 
    identifier = paste0(subject, stimulus_displayed)) %>% 
  left_join(df.deviant, by = "identifier") %>% 
  mutate(
    trial_type = if_else(deviant, "deviant", "background"),
    trial_complexity = case_when(
      grepl("simple", stimulus_displayed) ~ "simple", 
      grepl("complex", stimulus_displayed) ~ "complex"
    )
  ) %>%   
  mutate(trial_complexity = factor(trial_complexity, levels = c("simple", "complex"))) %>% 
  mutate(block_similarity = case_when(
      grepl("_similar", block_type) ~ "similar", 
      grepl("_dissimilar", block_type) ~ "dissimilar"
    )
  ) %>% 
  mutate(item_type = case_when(
    trial_type == 'background' ~ trial_type,
    trial_type == 'deviant' ~ paste(block_similarity, 'deviant')
    )
  ) %>%   
  mutate(item_type = factor(
    item_type, 
    levels = c("background",
               "similar deviant", 
               "dissimilar deviant")
      )
    )  %>% 
    mutate(item_id = 
             str_match(stimulus_displayed, "spore_stims/\\s*(.*?)..\\s*.gif")[,2]
    )  %>% 
  select(subject, block_number, block_type, trial_number, item_type, trial_type, trial_complexity, item_id, rt) %>% 
  transform(rt = as.numeric(rt))

write_csv(df.processed, here('data/processed_data/processed_RTdata.csv'))

# df.main
```

# Norming Data 
## similarity 
```{r}
# complexity doesn't have trial type
df.similarity <- df.raw %>% 
  filter(trial_type == "survey-likert") %>% 
  mutate(
    question_type = case_when(
      stimulus_type == "similarity_question" ~ "similarity", 
      TRUE ~ "complexity" 
    )
  ) %>% 
  filter(question_type =="similarity") %>% 
  select(subject, question_type, rt, responses, stimulus_left, stimulus_right) %>% 
  # a dumb way to extrat the rating
  separate(responses, into = c("question", "raw_answer"), sep = ":") %>% 
  mutate(
    rating = as.numeric(str_extract(raw_answer, "[[:digit:]]+"))) %>% 
  select(subject, question_type, stimulus_left, stimulus_right, rating)

write_csv(df.similarity, here('data/processed_data/processed_similaritydata.csv'))
```
## complexity 
```{r}
df.complexity <- df.raw %>% 
  filter(trial_type == "survey-likert") %>% 
  mutate(
    question_type = case_when(
      stimulus_type == "similarity_question" ~ "similarity", 
      TRUE ~ "complexity" 
    )
  ) %>% 
  filter(question_type =="complexity") %>% 
  select(subject, question_type, rt, responses, stimulus) %>% 
  # a dumb way to extrat the rating
  separate(responses, into = c("question", "raw_answer"), sep = ":") %>% 
  mutate(
    rating = as.numeric(str_extract(raw_answer, "[[:digit:]]+"))) %>% 
  select(subject, question_type, stimulus, rating)


write_csv(df.complexity, here('data/processed_data/processed_complexitydata.csv'))
```

# Demographic information 

```{r}
df.demog <- df.raw  %>% 
  filter(grepl("demog", trial_type)) %>% 
  select(subject, trial_type, responses) %>% 
  toJSON() %>% 
  fromJSON() %>% 
    mutate(
      demog_question = map(responses, ~ fromJSON(.) %>% as.data.frame())) %>% 
    unnest(demog_question)  %>% 
  group_by(subject) %>%
  mutate_at(vars(-group_cols()), function(x) {x[!is.na(x)][1]}) %>%
  distinct() %>% 
  select(-responses, -trial_type)

write_csv(df.demog, here('data/processed_data/processed_demogdata.csv'))
```

# TODO 
## put them together? <- not sure if necessary 
## exclusion criteria 
