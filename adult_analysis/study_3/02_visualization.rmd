---
title: "02_visualization"
author: "anjie"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
    
---

```{r}
library(tidyverse)
library(ggthemes)
library(here)
library(lme4)

#d <- read_csv(here("data/01_trimmed_data/trimmed_lt_d.csv"))
d <- read_csv(here("data/01_trimmed_data/corrected_lt_d.csv"))

```

```{r}
d %>% 
  filter(block_type == "deviant_block", trial_type == "deviant") %>% 
  ggplot(aes(x = val, y = total_rt)) + 
  geom_point() + 
  facet_wrap(~trial_number) + 
  geom_smooth(method = "lm")
```




# background only blocks 

## everything separate

```{r}
d %>% 
  filter(block_type == "background_block") %>% 
  ggplot(aes(x = trial_number, y = log(total_rt), color = background_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_wrap(~total_trial_number)
  
```

## animate vs inanimate 

```{r}
d %>% 
  filter(block_type == "background_block") %>% 
  ggplot(aes(x = trial_number, y = log(total_rt), color = animacy)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_wrap(~total_trial_number)
```

## singleton vs pair 

```{r}
d %>% 
  filter(block_type == "background_block") %>% 
  ggplot(aes(x = trial_number, y = log(total_rt), color = number)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_wrap(~total_trial_number)
```


## left vs right 

```{r}
d %>% 
  filter(block_type == "background_block") %>% 
  ggplot(aes(x = trial_number, y = log(total_rt), color = pose)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_wrap(~total_trial_number)
```


# deviant 

```{r}
d %>% 
   ggplot(aes(x = trial_number, y = log(total_rt), color = trial_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_grid(~violation_type)
```

## animate vs inanimate 

```{r}
d %>% 
   ggplot(aes(x = trial_number, y = log(total_rt), color = trial_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_grid(animacy~violation_type)
```


## singleton vs pair 

```{r}
d %>% 
   ggplot(aes(x = trial_number, y = log(total_rt), color = trial_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_grid(number~violation_type)
```

## left vs right 

```{r}

d %>% 
   ggplot(aes(x = trial_number, y = log(total_rt), color = trial_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few()  + 
  facet_grid(pose~violation_type)

```

# assuming background are the same 

```{r}
length(unique(d$subject))
```

```{r}

d %>% 
  mutate(half = if_else(block_number < 9, "first_half", "second_half")) %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_y_log10() + 
  facet_wrap(~half)
```


```{r}

d %>% 
  mutate(half = if_else(block_number < 9, "first_half", "second_half")) %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  scale_color_discrete(name = "Trial Type") + 
  scale_y_log10() + 
  facet_wrap(~block_number)

```

## investigate block number effect 

```{r}
d %>% 
  mutate(half = if_else(block_number < 9, "first_half", "second_half")) %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = trial_type)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  scale_color_discrete(name = "Trial Type") + 
  scale_y_log10() + 
  facet_wrap(~block_number)
```


```{r}
mean_background_lt_df <- d %>% 
  filter(trial_type == "background", 
         trial_number %in% c(2, 4, 6)) %>% 
  group_by(block_number, trial_number) %>% 
  summarise(mean_background_lt = mean(total_rt))


d %>% 
  filter(trial_type == "deviant", 
         trial_number %in% c(2, 4, 6), 
         violation_type == "pose"
         ) %>% 
  left_join(
    mean_background_lt_df, by = c("block_number", "trial_number")
  ) %>% 
  mutate(
    dishabituation_lt = total_rt - mean_background_lt
  ) %>% 
  ggplot(aes(x = block_number, y = dishabituation_lt)) +
  stat_summary(fun.data = "mean_cl_boot") + 
  geom_smooth(method = "lm") + 
  facet_grid(~trial_number)+ 
  scale_y_log10() + 
  theme_few() 

```




```{r}
d %>% 
  mutate(half = if_else(block_number < 9, "first_half", "second_half")) %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_y_log10() 
```




```{r}
d %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(trial_type != "background") |>
   ggplot(aes(x = violation_type, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_y_log10()#+ 
  #facet_wrap(~half)
```

## asymmetry? 
## by block 

```{r}
d %>% 
   mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(
  violation_type_with_background %in% c("background", "animacy")
) %>% 

  # try faceting 
  mutate(
    background_animacy = case_when(
      grepl("inanimate", background_stimulus) ~ "background: inanimate",
      TRUE ~ "background: animate"
    ), 
    deviant_animacy = case_when(
      grepl("inanimate", deviant_stimulus) ~ "deviant: inanimate", 
      deviant_stimulus == "null" ~ "deviant:na", 
      TRUE ~ "deviant: animate"
    )
  ) %>% 
  # try putting everything together 
  mutate(
    trial_type_detail = case_when(
      trial_type == "background"  & background_animacy == "background: inanimate" ~ "Ibackground", 
      trial_type == "background" &  background_animacy == "background: animate" ~ "Abackground", 
      trial_type == "deviant" & deviant_animacy == "deviant: inanimate" ~ "Ideviant", 
      trial_type == "deviant" & deviant_animacy == "deviant: animate" ~ "Adeviant"
    )
  ) %>% 
  mutate(background_deviant_combo = paste(background_animacy, deviant_animacy, sep = ";")) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = trial_type_detail)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  theme(legend.position = "bottom") + 
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  scale_y_log10() + 
  guides(colour = guide_legend(nrow = 2))+ 
  facet_wrap(~block_number)

```



## inanimate vs animate

```{r}
animacy_v_p <- d %>% 
   mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(
  violation_type_with_background %in% c("background", "animacy")
) %>% 

  # try faceting 
  mutate(
    background_animacy = case_when(
      grepl("inanimate", background_stimulus) ~ "background: inanimate",
      TRUE ~ "background: animate"
    ), 
    deviant_animacy = case_when(
      grepl("inanimate", deviant_stimulus) ~ "deviant: inanimate", 
      deviant_stimulus == "null" ~ "deviant:na", 
      TRUE ~ "deviant: animate"
    )
  ) %>% 
  # try putting everything together 
  mutate(
    trial_type_detail = case_when(
      trial_type == "background"  & background_animacy == "background: inanimate" ~ "Ibackground", 
      trial_type == "background" &  background_animacy == "background: animate" ~ "Abackground", 
      trial_type == "deviant" & deviant_animacy == "deviant: inanimate" ~ "Ideviant", 
      trial_type == "deviant" & deviant_animacy == "deviant: animate" ~ "Adeviant"
    )
  ) %>% 
  mutate(background_deviant_combo = paste(background_animacy, deviant_animacy, sep = ";")) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = trial_type_detail)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  theme(legend.position = "bottom") + 
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  scale_y_log10() + 
  guides(colour = guide_legend(nrow = 2))

```

## pair vs simple 

```{r}
number_v_p <- d %>% 
   mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(
  violation_type_with_background %in% c("background", "number")
) %>% 
  
  mutate(
    trial_type_detail = case_when(
      trial_type == "background"  & grepl("pair", background_stimulus)  ~ "2background", 
      trial_type == "background" & !grepl("pair", background_stimulus) ~ "1background", 
      trial_type == "deviant" & grepl("pair", deviant_stimulus) ~ "2deviant", 
      trial_type == "deviant" & !grepl("pair", deviant_stimulus) ~ "1deviant", 
    )
  ) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = trial_type_detail)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  theme(legend.position = "bottom") + 
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  theme(legend.position = "bottom")+
  scale_y_log10() +
  guides(colour = guide_legend(nrow = 2))


  #facet_wrap(~background_animacy)
```


```{r}
pose_v_p <- d %>% 
   mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(
  violation_type_with_background %in% c("background", "pose")
) %>% 
  
  mutate(
    trial_type_detail = case_when(
      trial_type == "background"  & grepl("left", background_stimulus)  ~ "Lbackground", 
      trial_type == "background" & grepl("right", background_stimulus) ~ "Rbackground", 
      trial_type == "deviant" & grepl("left", deviant_stimulus) ~ "Ldeviant", 
      trial_type == "deviant" & grepl("right", deviant_stimulus) ~ "Rdeviant", 
    )
  ) %>% 
   ggplot(aes(x = trial_number, y = total_rt, color = trial_type_detail)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  ylab("Reaction Time (ms)") + 
  xlab("Trial Number") + 
  scale_y_log10() + 
  theme(legend.position = "bottom") + 
  guides(colour = guide_legend(nrow = 2))
```


```{r}
library(patchwork)
animacy_v_p + number_v_p + pose_v_p
```




```{r}
d %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(trial_type != "background") |>
   ggplot(aes(x = total_rt, fill = violation_type_with_background)) + 
  geom_histogram(bins = 10) + 
  facet_wrap(~violation_type) + 
  theme_few() +
  scale_x_log10()
  #facet_wrap(~half)

```

```{r}
d %>% 
  mutate(half = if_else(block_number < 9, "first_half", "second_half")) %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
   ggplot(aes(x = trial_number, y = log(total_rt), color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  facet_grid(half~total_trial_number)+ 
  theme_few()
```

# super bad precision analysis
```{r}
d %>% 
  filter(violation_type != "error!") %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(trial_type != "background") |>
   ggplot(aes(x = violation_type, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_color_discrete(guide = "none") + 
  scale_y_log10() + 
  labs(title = "original")
```


```{r}
p1 <- d %>% 
   filter(violation_type != "error!") %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(trial_type != "background") |>
   ggplot(aes(x = violation_type, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_color_discrete(guide = "none") + 
  scale_y_log10() + 
  labs(title = "original")

p2 <- bind_rows(d, 
          d |> mutate(subject = str_c(subject, "-2")), 
          d |> mutate(subject = str_c(subject, "-3")), 
          d |> mutate(subject = str_c(subject, "-4")),
          d |> mutate(subject = str_c(subject, "-5")),
          d |> mutate(subject = str_c(subject, "-6")),
          d |> mutate(subject = str_c(subject, "-7")),
          d |> mutate(subject = str_c(subject, "-8")), 
          d |> mutate(subject = str_c(subject, "-9")), 
          d |> mutate(subject = str_c(subject, "-10"))) %>% 
   filter(violation_type != "error!") %>% 
  mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) %>% 
  filter(trial_type != "background") |>
   ggplot(aes(x = violation_type, y = total_rt, color = violation_type_with_background)) + 
   stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
    stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .2)) + 
  theme_few() +
  scale_color_discrete(guide = "none") +
  scale_y_log10() + 
  labs(title = "10x data")

cowplot::plot_grid(p1, p2)
```

# embedding relationships? 


log(looking time) ~ I((exp(1)**(-trial_number))) + I((exp(1)**(-trial_number))) * item_number + I((exp(1)**(-trial_number))) * item_orientation + I((exp(1)**(-trial_number))) * item_category + I((exp(1)**(-trial_number))) * trial_type + (trial_number * item_number | subject) + (trial_number * item_orientation | subject) + (trial_number * item_category | subject) + (trial_number * trial_type | subject)

## first run the model 

```{r}
d <- d %>% mutate(violation_type_with_background = case_when(
    trial_type == "background" ~ "background", 
    TRUE ~ violation_type
  )) 
```


```{r}

# very time intensive, didn't work? 

# m0 <- lmer(
#   log(total_rt) ~ I((exp(1) ** (-trial_number))) +
#                 I((exp(1)**(-trial_number))) * number +
#               I((exp(1)**(-trial_number)))  * pose +
#               I((exp(1)**(-trial_number)))  * animacy +
#               I((exp(1)**(-trial_number))) * violation_type_with_background +
#               (trial_number * number | subject) + (trial_number * pose | subject) + (trial_number * animacy | subject) + (trial_number * violation_type_with_background | subject),
#   data = d
# 
# )

# failed to converge
# m1 <- lmer(
#   log(total_rt) ~ I((exp(1) ** (-trial_number))) +
#                 I((exp(1)**(-trial_number))) * number +
#               I((exp(1)**(-trial_number)))  * pose +
#               I((exp(1)**(-trial_number)))  * animacy +
#               I((exp(1)**(-trial_number))) * violation_type_with_background +
#               (number | subject) + (pose | subject) + (animacy | subject) + (violation_type_with_background | subject),
#   data = d
# 
# )

# # failed to converge
# m2 <- lmer(
#   log(total_rt) ~ I((exp(1) ** (-trial_number))) +
#                 I((exp(1)**(-trial_number))) * number +
#               I((exp(1)**(-trial_number)))  * pose +
#               I((exp(1)**(-trial_number)))  * animacy +
#               I((exp(1)**(-trial_number))) * violation_type_with_background +
#              (violation_type_with_background | subject),
#   data = d
# 
# )

m3 <- lmerTest::lmer(
  log(total_rt) ~ I((exp(1) ** (-trial_number))) +
                I((exp(1)**(-trial_number))) * number +
              I((exp(1)**(-trial_number)))  * pose +
              I((exp(1)**(-trial_number)))  * animacy +
              I((exp(1)**(-trial_number))) * violation_type_with_background +
             (1 | subject),
  data = d

)

d$residual = resid(m3)


```

# get residual 

```{r}
resid_d <- d %>% 
  filter(violation_type_with_background != "background")
```



```{r}
resid_d %>% 
  group_by(background_stimulus, deviant_stimulus, violation_type, val) %>% 
  summarise(mean_rt = mean(total_rt)) %>% 
  ggplot(aes(x = val, y = mean_rt, color = violation_type)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  scale_y_log10()+
  facet_wrap(~violation_type) + 
  theme_few() + 
  labs(title = "RT average by individual background - deviant pair", 
       subtitle = "3~4 per group")

```



```{r}
resid_d %>% 
  group_by(background_stimulus, violation_type) %>% 
  summarise(
    mean_val = mean(val),
    mean_res = mean(residual)) %>% 
  ggplot(aes(x = mean_val, y = mean_res, color = violation_type)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  facet_wrap(~violation_type) + 
  theme_few() + 
  labs(title = "Res & distance group average by background stimulus ", 
       subtitle = "20~30 per group")

```

```{r}
resid_d %>% 
 group_by(background_stimulus, violation_type) %>% 
  summarise(
    mean_val = mean(val),
    mean_rt = mean(total_rt))%>% 
  ggplot(aes(x = mean_val, y = mean_rt, color = violation_type)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  scale_y_log10()+
  facet_wrap(~violation_type) + 
  theme_few() + 
   labs(title = "RT & distance group average by background stimulus ", 
       subtitle = "20~30 per group")
```



```{r}
resid_d %>% 
  group_by(deviant_stimulus, violation_type) %>% 
  summarise(
    mean_val = mean(val),
    mean_res = mean(residual)) %>% 
  ggplot(aes(x = mean_val, y = mean_res, color = violation_type)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  facet_wrap(~violation_type) + 
  theme_few() + 
  labs(title = "Res & distance group average by deviant stimulus ", 
       subtitle = "20~30 per group")
```



```{r}


resid_d %>% 
  ggplot(aes(x = val, y = residual, color = violation_type_with_background)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  theme_few() 

resid_d %>% 
  ggplot(aes(x = val, y = residual, color = violation_type_with_background)) + 
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") + 
  theme_few() + 
  facet_wrap(~ violation_type_with_background)
```


```{r}



summary(lm(residual ~ violation_type_with_background * val, 
   data = resid_d))
```



