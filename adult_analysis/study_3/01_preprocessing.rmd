---
title: "00_preprocessing.rmd"
author: "anjie"
date: "9/2/2021"
output: html_document
---
```{r}
library(tidyverse)
library(here)
library(jsonlite)

source(here("helper/tidy_rt_task_data.r"))

```

# set up paths 
```{r}

MERGED_DATA_PATH <- here("data/merged_data.csv")
d <- read_csv(MERGED_DATA_PATH)

```

```{r}
# looking time
lt_d <- d %>% 
  filter(trial_type == "curtain-display") %>% 
  filter(!is.na(background_type)) %>% 
  select(subject, trial_type, total_rt, block_type, 
         background_stimulus, deviant_stimulus, background_type, deviant_type, violation_type, 
         trial_number) %>% 
  select(-trial_type) %>% 
  rename(total_trial_number = trial_number) %>% 
  group_by(subject, background_stimulus, deviant_stimulus) %>% 
  mutate(trial_number = row_number()) %>% 
  left_join(
    d %>% filter(trial_type == "curtain-display") %>% 
  filter(!is.na(background_type)) %>% distinct(subject, background_stimulus, deviant_stimulus) %>% 
    group_by(subject) %>% mutate(block_number = row_number()), 
  by = c("subject", "background_stimulus", "deviant_stimulus")
  ) %>% 
  mutate(
    animacy = case_when(
    grepl("inanimate", background_type) ~ "inanimate", 
    TRUE ~ "animate"), 
    
    number = case_when(
    grepl("single", background_type) ~ "single", 
    TRUE ~ "pair"
  ),
  
    pose = case_when(
    grepl("left", background_type) ~ "left", 
    TRUE ~ "right"
  ),
  
    trial_type = case_when(
      (block_type == "deviant_block" &trial_number == total_trial_number) ~ "deviant", 
      TRUE ~ "background"
    )
  
    )
  
  
# curiosity rating 
curiosity_rating_df <- d %>% 
  filter(trial_type == "survey-likert") %>% 
  filter(!is.na(rating_type)) %>% 
  select(subject, rating_type, response) %>% 
  mutate(curiosity_rating = map(response, ~ fromJSON(.) %>% as.data.frame()) %>% unlist()) %>% 
  select(-response) %>% 
  group_by(subject) %>% 
  mutate(block_number = row_number()) %>% 
  left_join(lt_d %>% ungroup() %>%  distinct(subject, background_type, deviant_type, block_number) %>% 
              select(subject, background_type, deviant_type, block_number), by = c("subject", "block_number")) %>% 
  mutate(rating_stimus_type = case_when(
    rating_type == "background" ~ background_type, 
    rating_type == "deviant" ~ deviant_type
  )) %>% 
  mutate(
    animacy = case_when(
    grepl("inanimate", background_type) ~ "inanimate", 
    TRUE ~ "animate"), 
    
    number = case_when(
    grepl("single", background_type) ~ "single", 
    TRUE ~ "pair"
  ),
  
    pose = case_when(
    grepl("left", background_type) ~ "left", 
    TRUE ~ "right"
  )
    ) %>% 
  select(subject, rating_type, curiosity_rating, block_number, rating_stimus_type, animacy, number, pose)



```



# exclusion 

## Participant-based exclusion:

We exclude participants if either 
(a) the standard deviation of log-transformed of their reaction times on all trials is less than 0.15 
```{r}
low_var_in_sbj <- lt_d %>% 
  group_by(subject) %>% 
  summarise(mean_rt = mean(total_rt), 
            sd = sd(total_rt)) %>% 
  filter(sd < 0.15) %>% 
  pull(subject)

low_var_in_sbj

df_low_var <- tibble("exclude_reason" = rep("low_var", length(low_var_in_sbj)), 
                     sbj = low_var_in_sbj)
```

(b) spent more than three absolute deviations away from the medians of the task completion time as reported by Prolific.

```{r}
# gather all of the prolific data

MIN_ROW <- 90  #subject to change 

merge_and_deidentify_data <- function(raw_data_directory, 
                                      min_row){
  
  raw_files <- str_c(raw_data_directory, dir(here(raw_data_directory), "*.csv"))
  
  # count how many rows in each file 
  RAW_count <- map_df(raw_files, function(file) {
    d <- read_csv(file) %>% 
      count() %>% 
      mutate(
        file_name = file 
      )
  })   
  
  
  RAW_DATA <- map_df((RAW_count %>% filter(n > min_row))$file_name,
                     function(file){
                       d <- read_csv(file)
                     }) 
  
  
  return (RAW_DATA)
  
}

raw_d <- merge_and_deidentify_data(here("data/00_raw_data/"), MIN_ROW)

```


```{r}
p_df <- read_csv(here("data/prolific.csv")) %>% 
  janitor::clean_names()

p_summary <- p_df %>% 
  select(participant_id, time_taken) %>% 
   summarise(
     median = median(time_taken, na.rm = TRUE),
    mad = mad(time_taken, na.rm = TRUE), 
    upper = median + 3 * mad, 
    lower = median - 3 * mad) 

p_id <- p_df %>% 
  filter(time_taken > p_summary$upper | time_taken < p_summary$lower) %>% 
  select(participant_id) %>% 
  pull()

p_sbj <- raw_d %>% 
  distinct(subject, prolific_id) %>% 
  filter(prolific_id %in% p_id) %>% 
  pull(subject)
  
p_sbj

df_prolific <- tibble("exclude_reason" = rep("prolific", length(p_sbj)), 
                     sbj = p_sbj)
```






all excluded subject 
```{r}

participants_exclusion <- bind_rows(df_low_var, df_prolific)
write_csv(participants_exclusion, here("data/p_level_exclusion.csv"))


exclude_participant <- unique(c(
                               p_sbj, 
                               low_var_in_sbj))

```


```{r}

trimmed_lt_d <- lt_d %>% 
  filter(!(subject %in% exclude_participant))

trimmed_curiosity_rating_df <- curiosity_rating_df %>% 
  filter(!(subject %in% exclude_participant))


```


## Trial based exclusion:
We exclude a trial if it is three absolute deviations away from the median in the log-transformed space across all participants.

```{r}

rt_summary <- lt_d %>% 
  ungroup() %>% 
  summarise(
    median = median(log(total_rt)),
    mad = mad(log(total_rt)), 
    upper = median + 3 * mad, 
    lower = median - 3 * mad)
  
final_trimmed_lt_d <- trimmed_lt_d %>% 
  filter(!(log(total_rt) > rt_summary$upper | log(total_rt) < rt_summary$lower))

```

# Add embedding distance into the mix

```{r}
em_dis <- read_csv(here("data/eucledian_distances_with_number.csv")) %>% rename(stim_name = `...1`)
replace_name <- function(x) gsub("media/padded_stims/", "", x)
final_trimmed_lt_d <- final_trimmed_lt_d %>% 
  mutate_at(c("background_stimulus", "deviant_stimulus"), replace_name) %>% 
  mutate_at(c("background_stimulus", "deviant_stimulus"),
    funs(case_when(
      number == "single" ~ ., 
      TRUE ~ gsub("(.*)(\\.)", paste0("\\1_pair\\2"), .)
    )))


get_distance <- function(stim_a_name, stim_b_name,  dist){
  if (stim_a_name  == "null" | stim_b_name  == "null"){
    return (tibble("val" = NA_real_))
  }else{
    return( 
      tibble("val" = dist %>%
      filter(stim_name == {{stim_b_name}}) %>% 
      select({{stim_a_name}}) %>% 
      pull())
      )
  }
  
}

final_trimmed_lt_d <- final_trimmed_lt_d %>% 
  ungroup() %>% 
  mutate(edist = map2_df(.x = final_trimmed_lt_d$background_stimulus, 
                        .y = final_trimmed_lt_d$deviant_stimulus, 
                        .f = get_distance, em_dis)) %>% 
  unnest(edist)
```




# write out all the data 


```{r}
write_csv(final_trimmed_lt_d, here("data/01_trimmed_data/trimmed_lt_d.csv"))
write_csv(trimmed_curiosity_rating_df, here("data/01_trimmed_data/trimmed_curiosity_rating.csv"))

```



