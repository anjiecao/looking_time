---
title: "03_embedding_dis"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
library(tidyverse)
library(here)
library(jsonlite)
library(ggthemes)

cr <- read_csv(here("data/complexity_rating.csv")) %>% mutate(complexity_rating = complexity_rating + 1)
sr <- read_csv(here("data/similarity_rating.csv"))
em <- read_csv(here("data/adult_norming_embeddings.csv"))

c_dis <- read_csv(here("data/eucledian_distances_adultnorming.csv")) %>% rename(stim_name = `...1`)
e_dis <- read_csv(here("data/cosine_distances_adultnorming.csv"))%>% rename(stim_name = `...1`)


proportion_ds <- read_csv(here("data/em_dis_with_pair.csv"))


replace_name <- function(x) gsub("media/stimuli/", "", x)

clean_sr <- sr %>% 
  mutate_at(c("target", "left", "right"), replace_name) %>% 
  filter(!left_violation == "number" && !right_violation == "number")
```



## get the distinct triad and find the embedding distance value matching to it 

time consuming, should read directly 

```{r}
triad <- clean_sr %>% 
  distinct(target, left, right) %>% 
  filter(!is.na(target), !is.na(left), !is.na(right)) 


get_distance <- function(stim_a_name, stim_b_name, dist){
  
  tibble("val" = dist %>%
  filter(stim_name == {{stim_b_name}}) %>% 
  select({{stim_a_name}}) %>% 
  pull())
  
}

triad_ds <- triad %>% 
  mutate(left_cds = map2_df(.x = triad$target, .y = triad$left, .f = get_distance, c_dis), 
         left_eds = map2_df(.x = triad$target, .y = triad$left, .f = get_distance, e_dis), 
         right_cds =  map2_df(.x = triad$target, .y = triad$right, .f = get_distance, c_dis), 
         right_eds = map2_df(.x = triad$target, .y = triad$right, .f = get_distance, e_dis))


write_csv(proportion_ds, here("data/em_dis_with_pair.csv"))

```

## calculate proportion 

```{r}
proportion_ds <- triad_ds %>% 
  unnest(left_cds, left_eds, right_cds, right_eds) %>% 
  rename(left_cds = val, 
         left_eds = val1, 
         right_cds = val2, 
         right_eds = val3) %>% 
  filter(target != left, target != right) %>% 
  mutate(
    left_p_cds = left_cds / (left_cds + right_cds), 
    right_p_cds = right_cds / (left_cds + right_cds), 
    left_p_eds = left_eds / (left_eds + right_eds), 
    right_p_eds = right_eds / (left_eds + right_eds)
  )
```

# total plot 


```{r}
# calculate violation proportion
ds_proportion_df <- clean_sr %>% 
  left_join(proportion_ds, by = c("target", "left", "right")) %>% 
  filter(!is.na(left_cds)) %>% 
  mutate(
    choose_left_or_right = if_else(chosen_violation == left_violation, 
                                   "left", 
                                   "right"), 
    unchosen_cds = if_else(choose_left_or_right == "left", right_p_cds,left_p_cds), 
    unchosen_eds = if_else(choose_left_or_right == "left",  right_p_eds, left_p_eds), 
  ) %>% 
  select(subject, chosen_violation, unchosen_cds, unchosen_eds) %>% 
  pivot_longer(cols = c("unchosen_cds", "unchosen_eds"), 
               names_to = "proportion_type", 
               values_to = "proportion") 

```



```{r}
similarity_choice_df <- clean_sr %>% 
  group_by(subject) %>% 
  count() %>% 
  rename(n_trial = n) %>% 
  left_join(clean_sr, by = "subject") %>% 
  group_by(subject, n_trial, chosen_violation) %>% 
  count() %>% 
  filter(!is.na(chosen_violation)) %>%
  ungroup() %>% 
  mutate(proportion = n / n_trial) %>% 
  mutate(proportion_type = "sim_judgement") %>% 
  select(subject, chosen_violation, proportion_type, proportion)
```


```{r}
bind_rows(ds_proportion_df, similarity_choice_df) %>% 
  filter(chosen_violation != "number") %>% 
  ggplot(aes(x = chosen_violation, y = proportion, color = proportion_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2))+ 
  theme_few()
```


# by comparison 

```{r}
ds_proprotion_by_type_df <- clean_sr %>% 
  left_join(proportion_ds, by = c("target", "left", "right")) %>% 
  filter(!is.na(left_cds)) %>% 
  mutate(
    choose_left_or_right = if_else(chosen_violation == left_violation, 
                                   "left", 
                                   "right"), 
    unchosen_violation = if_else(chosen_violation == left_violation, 
                                   right_violation, 
                                    left_violation), 
    chosen_cds = if_else(choose_left_or_right == "left", left_p_cds, right_p_cds), 
    chosen_eds = if_else(choose_left_or_right == "left", left_p_eds, right_p_eds), 
    unchosen_cds = if_else(choose_left_or_right == "left", right_p_cds, left_p_cds), 
    unchosen_eds = if_else(choose_left_or_right == "left", right_p_eds, left_p_eds), 
  ) %>% 
  select(subject, chosen_violation, unchosen_violation, unchosen_cds, unchosen_eds) %>% 
  pivot_longer(cols = c("unchosen_cds", "unchosen_eds"), 
               names_to = "proportion_type", 
               values_to = "proportion") 
```



```{r}
clean_sr %>% 
  mutate(unchosen_violation = case_when(
    left_violation == chosen_violation ~ right_violation, 
    right_violation == chosen_violation ~ left_violation
  )) %>% 
  left_join(clean_sr %>% group_by(subject, chosen_violation) %>% count() %>% rename(total_n_in_cateogry = n), by = c("subject", "chosen_violation")) %>% 
  group_by(subject, chosen_violation, total_n_in_cateogry) %>% 
  count(unchosen_violation) %>% 
  mutate(proportion = n / total_n_in_cateogry) %>% 
  filter(!is.na(chosen_violation)) %>% 
  select(subject, chosen_violation, unchosen_violation, proportion) %>% 
  mutate(proportion_type = "sim_judgment") %>% 
  ungroup() %>% 
  bind_rows(ds_proprotion_by_type_df) %>% 
  filter(unchosen_violation != "number", chosen_violation != "number") %>% 
  ggplot(aes(x = unchosen_violation, y = proportion, color = proportion_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  facet_wrap(~chosen_violation) + 
  theme_few()
```


