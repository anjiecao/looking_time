---
title: "02b_visualization"
author: "anjie"
date: "4/14/2021"
html_document:
    toc: true
    toc_float: true
    number_sections: no
---

```{r message=FALSE, warning=FALSE}
library(lme4)
library(here)
library(tidyverse)
library(stringr) # for parsing r string 
library(jsonlite) # for parsing r string 
library(ggiraphExtra)
library(plotrix)
library(lmerTest)

```

```{r read_data, message=FALSE, warning=FALSE}
RT_data <- read_csv(here('data/processed_data/trimmed_RTdata.csv'))
similarity_data <- read_csv(here('data/processed_data/trimmed_similaritydata.csv'))
complexity_data <- read_csv(here('data/processed_data/trimmed_complexitydata.csv'))
demog_data <- read_csv(here('data/processed_data/trimmed_demogdata.csv'))
```

process the looking time! 
```{r}
RT_data <- RT_data %>% 
  mutate(looking_time = case_when(
    exposure_type == "forced_short" & trial_number == 1 ~ 500, 
    exposure_type == "forced_long" & trial_number == 1 ~ 15000, 
    TRUE ~ 500 + rt
  ))
```


check verbal feedback: 
```{r}

feedback <- read_csv(here('data/merged_data/merged_data.csv')) %>% 
  filter(stimulus_type == "feedback") %>% 
  select(subject, responses) %>% 
  toJSON() %>% 
  fromJSON() %>% 
    mutate(
      feedback = map(responses, ~ fromJSON(.) %>% as.data.frame())) %>% 
    unnest(feedback) %>% 
  select(subject, Q0) 

feedback %>% kableExtra::kable()
```




# Descriptive Info 
N = 200
```{r}
RT_data %>% 
  distinct(subject) %>% 
  count()
  
# reorder
RT_data$trial_complexity = factor(RT_data$trial_complexity, levels=c('simple', 'complex'))
RT_data$item_type = factor(RT_data$item_type, levels=c('background', 'similar deviant', 'dissimilar deviant'))

```

## demographic {.tabset}

## age 

```{r}
demog_data %>% 
  ggplot(aes(x = as.numeric(age))) + 
  geom_histogram()
```

### ethnicity 

```{r}
demog_data %>% 
  ggplot(aes(x = ethnicity)) + 
  geom_histogram(stat = "count") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### Gender 

```{r}
demog_data %>% 
  ggplot(aes(x = gender)) + 
  geom_histogram(stat = "count") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### education 
```{r}
demog_data %>% 
  ggplot(aes(x = education)) + 
  geom_histogram(stat = "count") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# RT raw {.tabset}

## overall 

```{r}
RT_data %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10()

```



## by trial type 
```{r}
RT_data %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~trial_type)
```

## trial type and block 
```{r}
RT_data %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_grid(block_type~trial_type)
```

## by trial complexity 
```{r}
RT_data %>% 
  ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~trial_complexity)
```

## by block type 
```{r}
RT_data %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~block_type)
```

## by exposure type 
```{r}
RT_data %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~exposure_type)
```



## by item id 
### simple 
```{r}
RT_data %>% 
  filter(trial_complexity == "simple") %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~item_id)
```

### complex 
```{r}
RT_data %>% 
  filter(trial_complexity == "complex") %>% 
   ggplot(aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~item_id)
```

# Similarity ratings {.tabset}



## Raw 

```{r}
similarity_data %>% 
  ggplot(aes(x = rating))+ 
  geom_histogram(bins = 30)
```

## complexity and similarity 

ahhhhhhhhh 

```{r}

similarity_data <- similarity_data %>% 
  mutate(
    complexity = case_when(
      grepl("complex", stimulus_left) | grepl("complex", stimulus_right) ~ "complex", 
      grepl("simple", stimulus_right) | grepl("simple", stimulus_right) ~ "simple"
    ), 
    stimulus_left_number = as.numeric(str_extract(stimulus_left, "[[:digit:]]+")), 
    stimulus_right_number = as.numeric(str_extract(stimulus_right, "[[:digit:]]+")), 
    similarity = case_when(
      stimulus_left_number == stimulus_right_number ~ "similar", 
      TRUE ~ "dissimilar"
    )
  )

similarity_data %>% 
  ggplot(aes(x = similarity, y= rating)) + 
  geom_point(alpha = 0.1, 
             position = position_jitter(width = 0.3)) + 
   stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~complexity)
```

# complexity 
## Raw 
```{r}
complexity_data %>% 
  ggplot(aes(x = rating))+ 
  geom_histogram(bins = 30)


```


## by intuitive complexity 
```{r}
complexity_data <- complexity_data %>% 
  mutate(
    complexity = case_when(
      grepl("complex", stimulus) ~ "complex", 
      grepl("simple", stimulus) ~ "simple"
    )
  )

complexity_data %>% 
  ggplot(aes(x = complexity, y = rating)) + 
  geom_point(alpha = 0.1, 
             position = position_jitter(width = 0.3)) + 
   stat_summary(fun.data = "mean_cl_boot") 
```




# zoom in on the effect of forced look duration 

## RT on the first trial (blank space confounding factor? )

```{r}
RT_data  %>%  
  filter(trial_number == 1) %>% 
ggplot(
       aes(x=exposure_type, y=log(rt), colour=exposure_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  #facet_wrap(~trial_complexity)+
  ylab("log RT (ms) at the first trial") + 
  xlab("exposure type") 
```

## look at the dynamics of the first trial self paced and the second trial 

```{r}
exposure_comparison_df <- RT_data  %>%  
  mutate(
    exposure_trial_comparison = case_when(
      trial_number == 2 & exposure_type == "forced_long" ~ "forced_long_second", 
      trial_number == 2 & exposure_type == "forced_short" ~ "forced_short_second", 
      trial_number == 1 & exposure_type == "self_paced" ~ "self_paced_first",
      TRUE ~ "irrelevant"
    )
  ) %>% 
  filter(exposure_trial_comparison != "irrelevant")

exposure_comparison_df %>% 
  ggplot(
       aes(x = exposure_trial_comparison, 
           y = log(looking_time), colour=item_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_hline(yintercept = exposure_comparison_df %>% filter(exposure_trial_comparison == "self_paced_first") %>% summarise(mean_lt = mean(log(looking_time))) %>% select(mean_lt) %>%  pull()) + 
  langcog::scale_color_solarized(name = "Item Type") + 
  #facet_wrap(~half)+
  #theme(legend.position = "bottom") + 
  ylab("log looking time (ms) at the second trial for forced block") + 
  xlab("exposure type") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



```{r}
exposure_comparison_df %>% 
ggplot(
       aes(x = block_number, 
           y = log(looking_time), colour=trial_complexity)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  langcog::scale_color_solarized(name = "Item Type") + 
  facet_wrap(~item_type)+
  #theme(legend.position = "bottom") + 
  ylab("log looking time (ms) at the second trial for forced block") + 
  xlab("exposure type") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


complexity? 
```{r}
exposure_comparison_df %>% 
  filter(exposure_trial_comparison != "self_paced_first") %>% 
ggplot(
       aes(x = block_number, 
           y = log(looking_time), colour=exposure_type)) +
  geom_smooth(se = FALSE)+
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  langcog::scale_color_solarized(name = "Item Type") + 
  facet_grid(trial_complexity~item_type)+
  #theme(legend.position = "bottom") + 
  ylab("log looking time (ms) at the second trial for forced block") + 
  xlab("exposure type") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```



# Within-block change plotting 

## RT
```{r}
ggplot(RT_data, 
       aes(x=trial_number, y=log(rt), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(exposure_type~trial_complexity) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("log RT (ms)") + 
  xlab("Trial Number") 
```

## Looking time 
### models
```{r}
prunned_model <-  lmer(log(looking_time) ~ I((exp(1)**(-trial_number))) * item_type * trial_complexity * exposure_type + (1|subject), 
                    data = RT_data)
summary(prunned_model)$coef %>% knitr::kable(digits = 2)
```

```{r}

prunned_model_second_trial <-  lmer(log(looking_time) ~ exposure_type * trial_complexity + (1|subject), data = RT_data %>% filter(trial_number == 2))

summary(prunned_model_second_trial)$coeff %>% knitr::kable(digits = 2)

```



### critical comparison 
```{r}
RT_data %>% 
  filter(trial_type == "background") %>% 
  filter(trial_number %in% c(1, 2)) %>% 
  ggplot(aes(x = trial_number, y = looking_time, colour = exposure_type)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .1))  + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", position = position_dodge(width = .1)) +
  langcog::scale_color_solarized(name = "Exposure Type") + 
  scale_x_continuous(breaks = seq(1,2,1)) + 
  facet_wrap(~trial_complexity)+
  theme_classic() + 
  xlab("Trial Number") + 
  ylab("Looking time (ms)") + 
  labs(title = "Looking time at critical trials (Second trial background only)")
```

```{r}
RT_data %>% 
  filter((trial_number == 1 & item_type == "background") | 
           trial_number == 2 & item_type == "dissimilar deviant") %>% 
  ggplot(aes(x = trial_number, y = looking_time, colour = exposure_type)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "line", position = position_dodge(width = .1))  + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", position = position_dodge(width = .1)) +
  langcog::scale_color_solarized(name = "Exposure Type") + 
  scale_x_continuous(breaks = seq(1,2,1)) + 
  facet_wrap(~trial_complexity)+
  theme_classic() + 
  xlab("Trial Number") + 
  ylab("Looking time (ms)") +
  labs(title = "Looking time at critical trials (Second trial deviants only)")
```




### compare looking time at the second trial

```{r}
RT_data %>% 
  filter(trial_number == 2) %>% 
  ggplot(aes(x = exposure_type, y = looking_time, color = item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", position = position_dodge(width = .1)) +
   langcog::scale_color_solarized(name = "Item Type") + 
  theme_classic() + 
  labs(title = "Looking time at the second trial")
```




```{r}
ggplot(RT_data, 
       aes(x=trial_number, y=looking_time, colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_wrap(~block_number) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
```

```{r}
ggplot(RT_data %>% filter(trial_number != 1), 
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(trial_complexity~exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
```




## first block only 

compare critical trials 
```{r}
exposure_comparison_df %>% 
  filter(block_number == 0) %>% 
  ggplot(
       aes(x = exposure_trial_comparison, 
           y = log(looking_time), colour=item_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  langcog::scale_color_solarized(name = "Item Type") + 
  facet_wrap(~trial_complexity)+
  #theme(legend.position = "bottom") + 
  ylab("log looking time (ms) at the second trial for forced block") + 
  xlab("exposure type") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


within block dynamic
```{r}
ggplot(RT_data %>% filter(trial_number != 1) %>% filter(block_number == 0), 
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(trial_complexity~exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 


```

# Across block 
```{r}
RT_data %>% 
  #filter(trial_number != 1) %>% 
  mutate(block_number = block_number + 1) %>%  #block number starts with 0
ggplot(
       aes(x=trial_number, y=looking_time, colour=trial_complexity)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  #geom_smooth(method = "lm", 
  #            formula = y ~ log(x), se = FALSE) + 
  facet_wrap(~block_number)+
  scale_x_continuous(breaks = seq(1, 12, 1))+
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  theme_classic()+
  ylab("Looking time)") + 
  xlab("Block Number") + 
  labs("Across block looking time change (exclude first trial)")
```



# some very exploratory stuff 
- effect of block length? 
- effect of deviant number? 
- what if we just look up to the first deviant? 

```{r}
temp_block_length <- RT_data %>% 
  mutate(temp_id = paste0(subject, block_number)) %>% 
  group_by(temp_id) %>% 
  summarise(n = max(trial_number))%>% 
  rename(block_length = n)


RT_data_block <- RT_data %>% 
  mutate(temp_id = paste0(subject, block_number)) %>% 
  left_join(temp_block_length, by = "temp_id")


```

```{r}
ggplot(RT_data_block %>% filter(trial_number != 1), 
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(block_length ~ exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
```





```{r}
ggplot(RT_data_block %>% filter(trial_number != 1), 
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(block_deviant_number~exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
```

what if we just look at the first deivant 
```{r}
RT_data_block %>% 
  filter(trial_number != 1) %>% 
  filter(trial_type_index == "background" | trial_type_index == "first_deviant") %>% 
ggplot(
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(~exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
```

how about throwing out all the background trials after the first deviant? 
```{r}
RT_data %>% 
  group_by(subject, block_number) %>% 
  filter(
    is.na(first_dev_position) |
    trial_number < first_dev_position | 
    trial_number ==  first_dev_position
  ) %>% 
  filter(trial_number != 1) %>% 
ggplot(
       aes(x=trial_number, y=log(looking_time), colour=item_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
  facet_grid(~exposure_type) +
  langcog::scale_color_solarized(name = "Item Type") + 
  theme(legend.position = "bottom") + 
  ylab("Looking time)") + 
  xlab("Trial Number") 
  
```

