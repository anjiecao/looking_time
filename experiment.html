<!DOCTYPE html>
<html>
<head>
  <script src = "js/require.js"></script>
  <script src="js/jspsych.js"></script>
  <script src="js/instruction_and_transition.js"></script>
  <script src = "js/practice_trial_package.js"></script>
  <script src = "js/demog_question_package.js"></script>
  <script src="js/jspsych-pratctice-block.js"></script>
  <script src="js/jspsych-stimulus-presentation.js"></script>
<script src="js/jspsych-sequential-stimulus-presentation.js"></script>
<script src = "js/jspsych-multi-stim-multi-response.js"></script>
  <script src="js/jspsych-task-instructions.js"></script>
  <script src="js/jspsych-instructions.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-image-keyboard-response.js"></script>
    <script src= "js/jspsych-survey-text.js"></script>
    <script src= "js/jspsych-categorize-image.js"></script>
    <script src="js/helper_for_generating_stimuli_array.js"></script>
    <script src="js/helper_for_checking_duplicate_stimuli.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
</head>
<body></body>
<script>

// Experiment setup
    var verbose = false
    var timenum = Date.now();
    var turkInfo = jsPsych.turk.turkInfo();

    // if we're not on MTurk, create a timestamp-based subject number; otherwise use turker ID
    var subject_id = 'SS' + timenum;
    var survey_code = 'SS' + timenum
    jsPsych.data.addProperties({ subject: subject_id });


    var timeline = []



// Stimuli setup
TEST_RUN = 1 //test run with smaller number of species etc.

if (TEST_RUN == 1) {
  NUM_BLOCKS = 4
  NUM_TRIAL_PER_BLOCK = 2
}
else {
  NUM_BLOCKS = 40
  NUM_TRIAL_PER_BLOCK = 8
}


all_stimuli = get_all_stimuli(TEST_RUN)
all_blocks_information = generate_all_block(num_blocks = NUM_BLOCKS,
                                            num_trial_per_block = NUM_TRIAL_PER_BLOCK,
                                            stimuli_array = all_stimuli,
                                            all_deviant_position_array = [2])


if (verbose){
console.log("All stimuli path: ")
console.log(all_stimuli)
console.log("All blocks information:")
console.log(all_blocks_information)
}




//timeline.push(block)

// need to loop through an outer loop that has all the blocks
// each block is a timeline variable array
// each timeline variable arrays contain the combination needed: N background + 10-N deviant, currently set to all 9 + 1
//


// loop through all blocks
for (var block_index = 0; block_index < all_blocks_information.length; block_index ++){

    block_information = all_blocks_information[block_index]
    block_timeline_variable = generate_timeline_variables(block_information)
    if (verbose){
    console.log("Each block time variable: ")
    console.log(block_timeline_variable)
    }
  //  pref_timeline_variable =

    var test_block = {
                        timeline: [
                            {
                                type: 'html-keyboard-response',
                                stimulus: '<p><img src= images/blank.png width ="200" height = "200" style = "float:right"></p><p><img src=images/blank.png width ="800" height = "200"></p>',
                                trial_duration: function(){
                                    var random_duration = 800 + 500 * Math.random()
                                    return random_duration  } , //The interval between the offset of one stimulus and the onset of the next stimulus ranged between 800 and 1300 msec
                                choices: jsPsych.NO_KEYS
                            },
                            {
                                type: 'sequential-stimulus-presentation',
                                poke_ball_animation: function(){
                                    var html = "<img src= "+jsPsych.timelineVariable('poke_ball_animation', true)+" width ='800' height = '200'></p>"
                                    return html;
                                },

                                stimuli_animation: function(){
                                    var html = "<p><img src="+jsPsych.timelineVariable('stimuli', true)+" width ='200' height = '200' style='float:" + jsPsych.timelineVariable('location', true) + "'></p>"
                                    return html
                                },
                                two_stimuli_interval: 1800,
                                key_response: [40],
                                minimum_viewing_duration: 200, // daffner2000's info was 600, changed to 200
                                response_ends_trial: true,
                            }
                            ],
                        timeline_variables: block_timeline_variable
                      }

        timeline.push(test_block)

      // enter preferences test here
      var preference_question = {
        type: 'html-keyboard-response',
        stimulus: '<img src=images/stimuli/pokeballs_closed.jpg width ="800" height = "200">',
        prompt: "<p> Which one would you like to open? </p>",
        choices: [49, 50, 51, 97, 98, 99],
        on_finish: function(data){
          if (data.key_press ==  49 || data.key_press == 97) {
            data.ball_pref = 1
            data.location = 'left'
          }
          else if (data.key_press ==  50 || data.key_press == 98){
            data.ball_pref = 2
            data.location = 'middle'
          }
          else if (data.key_press ==  51 || data.key_press == 99) {
            data.ball_pref = 3
            data.location = 'right'
          }
        }
      }

      timeline.push(preference_question)

     var reveal = {
       type: 'sequential-stimulus-presentation',
       poke_ball_animation: function(){
       var html = "<p><img src='images/stimuli/pokeball_" + jsPsych.data.get().last(1).values()[0].ball_pref + ".gif' width ='800' height = '200'></p>"
           return html;
       },

       stimuli_animation: function(){

           var html = "<p><img src='" + block_information['stims_in_order'][jsPsych.data.get().last(1).values()[0].ball_pref - 1] + "' width ='200' height = '200' style='float:" + jsPsych.data.get().last(1).values()[0].location + "'></p>"
           return html
       },
       two_stimuli_interval: 1800,
       key_response: [40],
       minimum_viewing_duration: 200, // daffner2000's info was 600, changed to 200
       response_ends_trial: true,
     }

     timeline.push(reveal)

}


function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://web.stanford.edu/~anjiecao/cgi-bin/daffner2000/write_data.php');
        //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }

// For loading

    //var all_images = INSTRCUTION_IMAGES.concat(ALL_STIMULI_PATH)
    //var all_images = all_images.concat(PRACTICE_IMAGES)


jsPsych.init({
        timeline: timeline,
        show_progress_bar: true,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        //preload_images: all_images,
        //preload_video: video,
        on_trial_finish: function(){
            saveData("test" + subject_id, jsPsych.data.get().csv());
            jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })

    </script>
</html>
