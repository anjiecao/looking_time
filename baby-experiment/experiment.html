<!DOCTYPE html>
<html>
<head>
  <script src="js/jspsych.js"></script>
  <script src="js/instruction_and_transition.js"></script>
<script src="js/jspsych-video-sequential-stimulus-presentation.js"></script>
  <script src = "js/practice_trial_package.js"></script>
  <script src = "js/demog_question_package.js"></script>
  <script src="js/jspsych-pratctice-block.js"></script>
  <script src="js/jspsych-stimulus-presentation.js"></script>
<script src="js/jspsych-sequential-stimulus-presentation.js"></script>
<script src = "js/jspsych-multi-stim-multi-response.js"></script>
  <script src="js/jspsych-task-instructions.js"></script>
  <script src="js/jspsych-instructions.js"></script>
  <script src="js/instructions.js"></script>
  <script src= "js/jspsych-survey-text.js"></script>
  <script src= "js/jspsych-survey-likert.js"></script>
    <script src="js/jspsych-html-slider-response.js"></script>
    <script src="js/jspsych-html-keyboard-response.js"></script>
    <script src="js/jspsych-image-keyboard-response.js"></script>
    <script src= "js/jspsych-survey-text.js"></script>
    <script src= "js/jspsych-categorize-image.js"></script>
    <script src="js/helper_for_generating_stimuli_array.js"></script>
    <script src="js/helper_for_checking_duplicate_stimuli.js"></script>
    <script src= "js/jspsych-demog-age.js"></script>
    <script src= "js/jspsych-demog-ethnic-US.js"></script>
    <script src= "js/jspsych-demog-gender-and-education.js"></script>
  <link rel="stylesheet" href="css/jspsych.css"></link>
</head>
<body></body>
<script>

// Experiment setup
    var verbose = false
    var timenum = Date.now();
    var turkInfo = jsPsych.turk.turkInfo();

    // if we're not on MTurk, create a timestamp-based subject number; otherwise use turker ID
    var subject_id = 'SS' + timenum;
    var survey_code = 'SS' + timenum
    jsPsych.data.addProperties({ subject: subject_id });

// Stimuli setup
TEST_RUN = 0 //test run with smaller number of species etc.

if (TEST_RUN == 1) {
  SHOW_INTRO = false
  NUM_BLOCKS = 2
  NUM_TRIAL_PER_BLOCK = 1
  DEVIANT_POSITIONS = [1]
  BREAK_EVERY_N_BLOCKS = 1
  SPECIES_NUM = 4

}
else {
  SHOW_INTRO = true
  NUM_BLOCKS = 6
  NUM_TRIAL_PER_BLOCK = 4
  DEVIANT_POSITIONS = [4]
  BREAK_EVERY_N_BLOCKS = 3
  SPECIES_NUM = 12

}

CONDITION_NUM = 2

ALL_STIMULI = get_all_stimuli(TEST_RUN)

console.log('all_stimuli')
console.log(all_stimuli)

all_blocks_information = generate_all_block(condition_num = CONDITION_NUM,
                                            num_blocks = NUM_BLOCKS,
                                            num_trial_per_block = NUM_TRIAL_PER_BLOCK,
                                            stimuli_array = ALL_STIMULI,
                                            all_deviant_position_array = DEVIANT_POSITIONS,
                                            num_species = SPECIES_NUM)

timeline = []

// loop through all blocks
for (var block_index = 0; block_index < all_blocks_information.length; block_index++){

    block_counter = 0
    block_information = all_blocks_information[block_index]
    block_type = block_information.block_type
    console.log('info: ' + block_information['stims_in_order'])
    block_timeline_variable = generate_timeline_variables(block_information)
    console.log('Block Timeline Variable')
    console.log(block_timeline_variable)

// For loading
var test_block = {
                    timeline: [
                        {
                            type: 'html-keyboard-response',
                            stimulus: '<p><img src= images/blank.png width ="200" height = "200" style = "float:right"></p><p><img src=images/blank.png width ="800" height = "200"></p>',
                            trial_duration: function(){
                                var random_duration = 800 + 500 * Math.random()
                                return random_duration  } , //The interval between the offset of one stimulus and the onset of the next stimulus ranged between 800 and 1300 msec
                            choices: jsPsych.NO_KEYS
                        },
                        {
                            type: 'sequential-stimulus-presentation',
                            wall_animation: function(){
                                //var html = "<img src= "+jsPsych.timelineVariable('poke_ball_animation', true)+ "?a="+Math.random() +" width ='800' height = '200'></p>"
                                var html = "<video width ='960' height = '540' autoplay muted><source src=" + jsPsych.timelineVariable('wall_animation', true) + ' type="video/mp4"></video>'
                                //var html = "<img src= "+ "images/stimuli/pokeball_1.gif" +" width ='800' height = '200'></p>"
                                return html;
                            },

                            stimuli_animation: function(){
                                var html = "<p><img src="+jsPsych.timelineVariable('stimuli', true)+" width ='200' height = '200' style='position:absolute;top:43%;left:"+jsPsych.timelineVariable('location_percent', true)+"'></p>"
                                return html
                            },
                            two_stimuli_interval: 800,
                            key_response: [40],
                            minimum_viewing_duration: 800, // block responses until stimulus appears
                            response_ends_trial: true,
                            trial_duration: jsPsych.timelineVariable('trial_duration'),
                            data: {block_number: block_index, block_type: block_type,  stimulus_type: 'trial', stimulus_displayed: jsPsych.timelineVariable('stimuli'), position_displayed: jsPsych.timelineVariable('location'), trial_type: jsPsych.timelineVariable('stim_type')},
                        }
                        ],
                    timeline_variables: block_timeline_variable
                  }

    timeline.push(test_block)

  }


  function saveData(name, data){
          var xhr = new XMLHttpRequest();
          xhr.open('POST', '../../../cgi-bin/pokebaby/write_data.php');
          //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(JSON.stringify({filename: name, filedata: data}));
      }




jsPsych.init({
        timeline: timeline,
        show_progress_bar: true,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        preload_images: all_stimuli,
        //preload_video: VIDEO,
        on_trial_finish: function(){
            saveData("test" + subject_id, jsPsych.data.get().csv());
            //jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })

    </script>
</html>
