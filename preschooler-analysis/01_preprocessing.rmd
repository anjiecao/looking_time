---
title: "01_preprocessing.rmd"
author: "anjie"
date: "9/16/2021"
output: html_document
---

```{r}
library(tidyverse)
library(here)

source(here("helper/clean_data.R"))

MERGED_DATA_PATH <- here("data/01_merged_data/merged_data.csv")
bing_d <- read_csv(here("data/bing_info.csv"))
bing_d <- bing_d %>% filter(study_name_frank == 16) %>% 
  select(bing_id, child_age_today_scheduling) %>% 
  mutate(child_age_group = case_when(
    child_age_today_scheduling > 3 & child_age_today_scheduling <= 4 ~ "3", 
    child_age_today_scheduling > 4 & child_age_today_scheduling <= 5 ~ "4",
    child_age_today_scheduling > 5 & child_age_today_scheduling <= 6 ~ "5",
  )) 

raw_df <- read_csv(MERGED_DATA_PATH) %>% 
  left_join(bing_d, by = "bing_id")

```



# preprocessed df 

```{r}

main_d <- tidy_all_rt_task_data(raw_df)
adult_d <- read_csv(here("data/adult_data.csv")) %>% mutate(child_age_group = "adult")

main_d <- main_d %>% 
  bind_rows(adult_d) %>% 
  mutate(participant_type = case_when(
    child_age_group == "adult" ~ "adult", 
    TRUE ~ "kids"
  ))
# missing: memory question
```

```{r}
main_d %>% 
  distinct(bing_id, child_age_group) %>% 
  group_by(child_age_group) %>% 
  count()
```

```{r}
main_d %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time), color = trial_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") + 
  theme(legend.position = "bottom") + 
  ylab("log RT (seconds)") + 
  xlab("Trial Number") + 
  facet_wrap(~participant_type)
```


```{r}

 main_d %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2),
               aes(color = as.factor(participant_type)
               )) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2),
               aes(color = as.factor(participant_type))
              ) + 
  facet_wrap(~deviant_position)+  
  xlab("Trial Number") + 
     theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") 
```


```{r}
 
 main_d %>% 
  filter(participant_type == "kids") %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  facet_wrap(~deviant_position)+  
  xlab("Trial Number") + 
     theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") 
 
```




Trial based exclusion:
We exclude a trial if it is three absolute deviations away from the median in the log-transformed space across all participants. If the participant fails to complete more than 50 percent of the study they will be excluded.
Participant-based exclusion:
We exclude participants if either (a) the standard deviation of log transformed of their reaction times on all trials is less than 0.15 or (b) they answer 3 out of 8 the memory task questions incorrectly.

```{r}


memory_score <- raw_df %>% 
  filter(stimulus_type == "memory_test") %>% 
  select(subject, button_pressed, memory_options_left, memory_options_right) %>% 
  group_by(subject) %>% 
  mutate(block_id = row_number()) %>% 
  left_join(
    raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, block_number, block_deviant, block_background) %>% 
  distinct(subject, block_number, block_deviant, block_background) %>% 
  mutate(block_id = block_number + 1) %>% 
  select(-block_number), 
  by = c("subject", "block_id")
  ) %>% 
  ungroup() %>% 
  mutate(
    corret_response = case_when(
      memory_options_left == block_deviant | memory_options_left == block_background ~ 0, 
       memory_options_right == block_deviant | memory_options_right == block_background ~ 1
    )
  ) %>% 
  mutate(
    response_correct = (button_pressed == corret_response)
  ) %>% 
  select(subject, button_pressed, block_id, response_correct) %>% 
  group_by(subject) %>% 
  summarise(
    memory_total = sum(response_correct)
  )
  
memory_score

super_kid_id <- memory_score %>% 
  filter(memory_total > 5) %>% 
  select(subject) %>% 
  pull()
```

```{r}
memory_score 
included_participants_df
include_sbj_id %>% 
  left_join(memory_score, by = "subject") %>% 
  left_join(included_participants_df %>% rename(responses = `RedCAP ID`), 
            by ="responses") %>% 
  separate(`Subject ID`, into = c("age_group", "id"), sep = "_") %>% 
  ggplot(aes(x = memory_total)) + 
  geom_histogram() + 
  facet_wrap(~age_group)
```


```{r}
raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  filter(subject %in% super_kid_id) %>% 
  group_by(subject, block_number) %>% 
  mutate(trial_number = row_number()) %>% 
  mutate(item_type = case_when(
    stimulus_displayed == block_background ~ "background", 
    stimulus_displayed == block_deviant ~ "deviant"
  )) %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time), color = item_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
   theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") + 
  theme(legend.position = "bottom") + 
  ylab("log RT (seconds)") + 
  xlab("Trial Number")
```



```{r}
rt_summary <- raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  summarise(
    median = median(log(trial_looking_time)),
    mad = mad(log(trial_looking_time)), 
    upper = median + 3 * mad, 
    lower = median - 3 * mad)
  
trimmed_raw_df_task <- raw_df %>% 
   filter(stimulus_type == "trial") %>% 
  filter(!(log(trial_looking_time) > rt_summary$upper | log(trial_looking_time) < rt_summary$lower))
```

