---
title: "01_preprocessing.rmd"
author: "anjie"
output: html_document
---

```{r}
library(tidyverse)
library(here)

source(here("helper/clean_data.R"))

MERGED_DATA_PATH <- here("data/01_merged_data/merged_data.csv")
bing_d <- read_csv(here("data/bing_info.csv"))
bing_d <- bing_d %>% filter(study_name_frank == 16) %>% 
  select(bing_id, child_age_today_scheduling) %>% 
  mutate(
    age_in_months = child_age_today_scheduling * 12, 
    child_age_group = case_when(
    child_age_today_scheduling > 3 & child_age_today_scheduling <= 4 ~ "3", 
    child_age_today_scheduling > 4 & child_age_today_scheduling <= 5 ~ "4",
    child_age_today_scheduling > 5 & child_age_today_scheduling <= 6 ~ "5",
  )) 

raw_df <- read_csv(MERGED_DATA_PATH) %>% 
  left_join(bing_d, by = "bing_id")

```



# preprocessed df 

```{r}

main_d <- tidy_all_rt_task_data(raw_df)
adult_d <- read_csv(here("data/adult_data.csv")) %>% mutate(child_age_group = "adult") %>% 
  filter(grepl("complex", block_type))

main_d <- main_d %>% 
  bind_rows(adult_d) %>% 
  mutate(participant_type = case_when(
    child_age_group == "adult" ~ "adult", 
    TRUE ~ "kids"
  ))
# missing: memory question

```


# exclusion criteria: 

## memory question and memory practice 

```{r}
failed_memory_test_kids <- raw_df %>% 
  select(subject, 
         stimulus_type, 
         memory_block_index, button_pressed, correct_answer) %>% 
  filter(stimulus_type == "memory_test") %>% 
  mutate(block_number = memory_block_index + 1, 
         memory_correct = ((button_pressed == 0 & correct_answer == "left") | 
                            (button_pressed == 1 & correct_answer == "right"))) %>% 
  group_by(subject) %>% 
  summarise(sum_correct = sum(as.numeric(memory_correct))) %>% 
  filter(sum_correct <= 4) %>% 
  pull(subject)

failed_memory_practice_kids <- raw_df %>% 
  select(subject, 
         stimulus_type, 
         memory_block_index, button_pressed, correct_answer) %>% 
  filter(stimulus_type == "memory_practice") %>% 
  mutate(block_number = memory_block_index + 1, 
         memory_correct = ((button_pressed == 0 & correct_answer == "left") | 
                            (button_pressed == 1 & correct_answer == "right"))) %>% 
  group_by(subject) %>% 
  summarise(sum_correct = sum(as.numeric(memory_correct))) %>% 
  filter(sum_correct == 0) %>% 
  pull(subject)

```

## looking time 

```{r}
flat_looking_time <- main_d %>% 
  filter(participant_type == "kids") %>% 
  group_by(subject) %>% 
  mutate(sd_lt = (log(sd(trial_looking_time)))) %>% 
  filter(sd_lt < 0.15) %>% 
  pull(subject)
```

```{r}

```



## exclude participants 

```{r}
main_d <- main_d %>% 
  filter(!(subject %in% failed_memory_test_kids)) %>% 
  filter(!(subject %in% failed_memory_practice_kids), 
         !(subject %in% flat_looking_time))
```

## exclude trial 

```{r}
summary_lt_d <- main_d %>% 
  filter(participant_type == "kids") %>% 
  summarise(
     median = median(log(trial_looking_time)),
    mad = mad(log(trial_looking_time)), 
    upper = median + 3 * mad, 
    lower = median - 3 * mad) 


main_d <- main_d %>% 
  filter((participant_type == "kids" & log(trial_looking_time) > summary_lt_d$lower 
          & log(trial_looking_time) < summary_lt_d$upper) | participant_type == "adult"
          )
```

```{r}
write_csv(main_d, here("data/02_processed_data/clean_data.csv"))
```



# final sample sie 

```{r}
main_d %>% 
  distinct(subject, child_age_group) %>% 
  group_by(child_age_group) %>% 
  count()
```

```{r}
<<<<<<< HEAD
 main_d %>% 
  filter(participant_type == "kids") %>% 
  ggplot(aes(x = log(trial_looking_time), fill = as.factor(child_age_group))) + 
  geom_density(alpha = .3)   + 
  facet_wrap(~trial_type)
=======
main_d %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time), color = trial_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
   theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") + 
  theme(legend.position = "bottom") + 
  ylab("log RT (seconds)") + 
  xlab("Trial Number") + 
  facet_wrap(~participant_type)
>>>>>>> parent of eadf883f (long overdue preschooler analysis)
```


## kids only 

```{r}
 main_d %>% 
  filter(participant_type == "kids") %>% 
  #filter(child_age_group > 3) %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  facet_wrap(~deviant_position_print)+  
  xlab("Trial Number") + 
    ylab("Looking Time (Log msc)")+

     theme_classic()+
  langcog::scale_color_solarized(name = "Participant Type") 
```


## kids vs adults

```{r}

 main_d %>% 
<<<<<<< HEAD
  #filter(participant_type == "adult") %>% 
  #filter(child_age_group > 3) %>% 
=======
>>>>>>> parent of eadf883f (long overdue preschooler analysis)
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2),
               aes(color = as.factor(participant_type))) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2),
               aes(color = as.factor(participant_type))
              ) + 
  facet_wrap(~deviant_position)+  
  xlab("Trial Number") + 
     theme_classic()+
  langcog::scale_color_solarized(name = "Participant Type") 
```

## 3 vs 4 vs 5

```{r}

 main_d %>% 
  filter(participant_type == "kids") %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  facet_wrap(~deviant_position)+  
  xlab("Trial Number") + 
     theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") 
 
```

## 3 vs 4 vs 5 vs adults 
```{r}

<<<<<<< HEAD
 main_d %>% 
  #filter(participant_type == "kids") %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time))) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  stat_summary(geom = "line", fun.data = "mean_cl_boot", position = position_dodge(width = .2), 
               aes(color = as.factor(child_age_group))) + 
  facet_wrap(~deviant_position_print)+  
  xlab("Trial Number") + 
  ylab("Looking Time (Log msc)")+
     theme_classic()+
  langcog::scale_color_solarized(name = "Age Group") 
 
```
=======


Trial based exclusion:
We exclude a trial if it is three absolute deviations away from the median in the log-transformed space across all participants. If the participant fails to complete more than 50 percent of the study they will be excluded.
Participant-based exclusion:
We exclude participants if either (a) the standard deviation of log transformed of their reaction times on all trials is less than 0.15 or (b) they answer 3 out of 8 the memory task questions incorrectly.

```{r}


memory_score <- raw_df %>% 
  filter(stimulus_type == "memory_test") %>% 
  select(subject, button_pressed, memory_options_left, memory_options_right) %>% 
  group_by(subject) %>% 
  mutate(block_id = row_number()) %>% 
  left_join(
    raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  select(subject, block_number, block_deviant, block_background) %>% 
  distinct(subject, block_number, block_deviant, block_background) %>% 
  mutate(block_id = block_number + 1) %>% 
  select(-block_number), 
  by = c("subject", "block_id")
  ) %>% 
  ungroup() %>% 
  mutate(
    corret_response = case_when(
      memory_options_left == block_deviant | memory_options_left == block_background ~ 0, 
       memory_options_right == block_deviant | memory_options_right == block_background ~ 1
    )
  ) %>% 
  mutate(
    response_correct = (button_pressed == corret_response)
  ) %>% 
  select(subject, button_pressed, block_id, response_correct) %>% 
  group_by(subject) %>% 
  summarise(
    memory_total = sum(response_correct)
  )
  
memory_score

super_kid_id <- memory_score %>% 
  filter(memory_total > 5) %>% 
  select(subject) %>% 
  pull()
```

```{r}
memory_score 
included_participants_df
include_sbj_id %>% 
  left_join(memory_score, by = "subject") %>% 
  left_join(included_participants_df %>% rename(responses = `RedCAP ID`), 
            by ="responses") %>% 
  separate(`Subject ID`, into = c("age_group", "id"), sep = "_") %>% 
  ggplot(aes(x = memory_total)) + 
  geom_histogram() + 
  facet_wrap(~age_group)
```


```{r}
raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  filter(subject %in% super_kid_id) %>% 
  group_by(subject, block_number) %>% 
  mutate(trial_number = row_number()) %>% 
  mutate(item_type = case_when(
    stimulus_displayed == block_background ~ "background", 
    stimulus_displayed == block_deviant ~ "deviant"
  )) %>% 
  ggplot(aes(x = trial_number, y = log(trial_looking_time), color = item_type)) +
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  geom_smooth(method = "lm", 
              formula = y ~ I(exp(1)**(-x)), se = FALSE) + 
   theme_classic()+
  langcog::scale_color_solarized(name = "Trial Type") + 
  theme(legend.position = "bottom") + 
  ylab("log RT (seconds)") + 
  xlab("Trial Number")
```



```{r}
rt_summary <- raw_df %>% 
  filter(stimulus_type == "trial") %>% 
  summarise(
    median = median(log(trial_looking_time)),
    mad = mad(log(trial_looking_time)), 
    upper = median + 3 * mad, 
    lower = median - 3 * mad)
  
trimmed_raw_df_task <- raw_df %>% 
   filter(stimulus_type == "trial") %>% 
  filter(!(log(trial_looking_time) > rt_summary$upper | log(trial_looking_time) < rt_summary$lower))
```

>>>>>>> parent of eadf883f (long overdue preschooler analysis)
